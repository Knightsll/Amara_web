<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amara Bot</title>
    <link rel="stylesheet" href="test_page.css">
    <style>
        #fileProtocolWarning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            padding: 20px;
            box-sizing: border-box;
        }

        #fileProtocolWarning h2 {
            color: #ff4d4d;
            margin-bottom: 20px;
        }

        #fileProtocolWarning pre {
            background-color: green;
            font-size: 18px;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            overflow-x: auto;
            margin: 15px 0;
        }

        #fileProtocolWarning button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px 2px;
            cursor: pointer;
            border-radius: 4px;
        }

        #fileProtocolWarning button:hover {
            background-color: #45a049;
        }
    </style>
    <script>
        // 检测是否使用file://协议打开
        if (window.location.protocol === 'file:') {
            document.addEventListener('DOMContentLoaded', function () {
                // 创建警告框
                const warningDiv = document.createElement('div');
                warningDiv.id = 'fileProtocolWarning';
                warningDiv.innerHTML = `
                    <h2>⚠️ 警告：请使用HTTP服务器打开此页面</h2>
                    <p>您当前使用的是本地文件方式打开页面（file://协议），这可能导致页面功能异常。</p>
                    <p>您可以使用nginx映射启动测试页面，也可以请按照以下步骤使用python启动测试http服务：</p>
                    <ol>
                        <li>打开命令行终端</li>
                        <li>命令行进入到 xiaozhi-server/test 目录</li>
                        <li>执行以下命令启动HTTP服务器：</li>
                    </ol>
                    <pre>python -m http.server 8006</pre>
                    <p>然后在浏览器中访问：<strong>http://localhost:8006/test_page.html</strong></p>
                `;
                document.body.appendChild(warningDiv);
            });
        }
    </script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js",
                "three/examples/jsm/": "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/"
            }
        }
    </script>
</head>

<body>
    <div class="container">
        <h1>Amara Bot</h1>

        <div id="scriptStatus" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            Loading Opus Lib...
        </div>

        <!-- 添加配置面板 -->
        <div class="section">
            <h2>
                Hardware Setting
                <span class="device-info">
                    <span>MAC: <strong id="displayMac"></strong></span>
                    <span>Client: <strong id="displayClient">web_test_client</strong></span>
                </span>
                <button class="toggle-button" id="toggleConfig">Edit</button>
            </h2>
            <div class="config-panel" id="configPanel">
                <div class="control-panel">
                    <div class="config-item">
                        <label for="deviceMac">Device MAC:</label>
                        <input type="text" id="deviceMac" placeholder="设备MAC地址">
                    </div>
                    <div class="config-item">
                        <label for="deviceName">Device Name:</label>
                        <input type="text" id="deviceName" value="Web测试设备" placeholder="设备名称">
                    </div>
                    <div class="config-item">
                        <label for="clientId">Client ID:</label>
                        <input type="text" id="clientId" value="web_test_client" placeholder="客户端ID">
                    </div>
                    <div class="config-item">
                        <label for="token">Auth Token:</label>
                        <input type="text" id="token" value="your-token1" placeholder="认证Token">
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>
                Connect Message
                <span class="connection-status">
                    <span>OTA: <span id="otaStatus" class="status">ota disconnected</span></span>
                    <span>WS: <span id="connectionStatus" class="status">ws disconnected</span></span>
                </span>
            </h2>
            <div class="connection-controls">
                <input type="text" id="otaUrl" value="http://127.0.0.1:8002/xiaozhi/ota/"
                    placeholder="OTA服务器地址，如：http://127.0.0.1:8002/xiaozhi/ota/" />
                <input type="text" id="serverUrl" value="ws://127.0.0.1:8000/xiaozhi/v1/"
                    placeholder="WebSocket服务器地址，如：ws://127.0.0.1:8000/xiaozhi/v1/" />
                <button id="connectButton">Connect</button>
                <button id="authTestButton">Test Auth</button>
            </div>
        </div>

        <div class="section">
            <div class="tabs">
                <button class="tab active" data-tab="text">Text Message</button>
                <button class="tab" data-tab="voice">Voice Message</button>
            </div>

            <div class="tab-content active" id="textTab">
                <div class="message-input">
                    <input type="text" id="messageInput" placeholder="Input Message..." disabled>
                    <button id="sendTextButton" disabled>Send</button>
                </div>
            </div>

            <div class="tab-content" id="voiceTab">
                <div class="audio-controls">
                    <button id="recordButton" class="record-button" disabled>Start Record</button>
                </div>
                <canvas id="audioVisualizer" class="audio-visualizer"></canvas>
            </div>
        </div>

        <div class="section">
            <h2>Chat History</h2>
            <div class="flex-container">
                <div id="conversation" class="conversation"></div>
                <div id="logContainer">
                    <div class="log-entry log-info">Ready, connect server to start...</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>3D Model Control</h2>
            <div class="model-controls">
                <input type="file" id="modelFileInput" accept=".gltf,.glb">
                <button id="unloadModelButton" disabled>Remove Model</button>
            </div>
            <div class="blendshape-stream-controls">
                <input type="text" id="blendshapeWsUrl" value="ws://127.0.0.1:8765/blendshape"
                    placeholder="Blendshape WebSocket，例如 ws://127.0.0.1:8765/blendshape">
                <button id="connectBlendshapeWs">Connect Stream</button>
                <button id="disconnectBlendshapeWs" disabled>Disconnect</button>
            </div>
            <div id="modelViewer" class="model-viewer"></div>
            <div id="blendshapeControls" class="blendshape-controls">
                <p class="blendshape-empty" id="blendshapeEmptyHint">Load a model with blendshapes to see controls.</p>
            </div>
            <div class="stream-status">
                <span>Stream status: <span id="streamStatus">model not loaded</span></span>
            </div>
        </div>
    </div>

    <!-- Opus解码库 -->
    <script src="libopus.js"></script>

        <script type="module" src="./js/testPageMain.js"></script>
</body>

</html>
